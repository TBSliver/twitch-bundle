module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";var r=function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},a=function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function u(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}c((r=r.apply(e,t||[])).next())}))},o=function(e,t){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}};Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),u=n(2),c=n(5),s=n(6),l=n(7),d=n(8);t.default=function(e){var t,n,f,p=this,h=e.Replicant("twitchCredentials",{defaultValue:{clientId:"",clientSecret:"",accessToken:void 0,refreshToken:void 0,expiresIn:0,obtainmentTimestamp:0,connectedAs:void 0,isConnected:!1}}),v=e.Replicant("twitchEvents",{defaultValue:[]}),m=e.Replicant("twitchClips",{defaultValue:[]}),g=e.Replicant("twitchChat",{defaultValue:[]});e.Replicant("twitchSelectedClips",{defaultValue:{}});var b={},w={},y={},S=function(t){return function(n){e.log.info("Received message "+t),e.log.info("Raw Data: "+JSON.stringify(n[d.rawDataSymbol].data,null,4)),v.value.unshift({type:"PubSub",messageName:t,data:n[d.rawDataSymbol].data}),e.sendMessage(t,n[d.rawDataSymbol].data)}},_=function(){h.value.connectedAs&&t.clips.getClipsForBroadcasterPaginated(h.value.connectedAs).getAll().then((function(e){m.value=e.sort((function(e,t){return t.creationDate.getTime()-e.creationDate.getTime()})).map((function(e){var t=e.id,n=e.creatorDisplayName,r=e.title,a=e.creationDate;return{id:t,url:e.thumbnailUrl.replace("-preview-480x272.jpg",".mp4"),creator_name:n,title:r,created_at:a.toISOString()}}))}))},T=e.Replicant("twitchHello",{defaultValue:[]}),R=e.Replicant("twitchHelloIgnore",{defaultValue:[]}),x=function(e,t,n,a){if(e==="#"+h.value.connectedAs.name){g.value.length>50&&g.value.shift();var o=r(r({},a),{rawMessage:n,username:a.userInfo.displayName,user_colour:a.userInfo.color,user_badges:(i=a.userInfo.badges,u=[],i.forEach((function(e,t){var n=y[t];if(n){var r=n.getVersion(e);u.push(r.getImageUrl(1))}})),u),parsedMessage:a.parseEmotes(),messageId:a.id,messageTime:(new Date).getTime()});g.value.push(o),function(e){T.value.findIndex((function(t){return t.username===e.username}))>=0||R.value.includes(e.username)||T.value.push({username:e.username,firstMessageTimestamp:e.messageTime})}(o)}var i,u},k=function(e,t){g.value=g.value.map((function(e){return e.messageId===t&&(e.parsedMessage=[{type:"text",text:"__REDACTED__",length:12,position:0}],e.username="USER PURGED"),e}))},A=function(e,t){g.value=g.value.map((function(e){return e.username===t&&(e.parsedMessage=[{type:"text",text:"_ _ REDACTED _ _",length:12,position:0}],e.username="USER PURGED"),e}))},C=e.Replicant("twitchSubscribers",{defaultValue:[]}),P=e.Replicant("twitchFollowers",{defaultValue:[]});e.listenFor("refreshCredits",(function(n,r){return a(p,void 0,void 0,(function(){var n,a,i;return o(this,(function(o){switch(o.label){case 0:return e.log.info("refreshCredits"),[4,t.subscriptions.getSubscriptions(h.value.connectedAs)];case 1:return n=o.sent(),C.value=n.data.filter((function(e){return e.userName!==h.value.connectedAs.name})).map((function(e){return{username:e.userDisplayName}})),a=t.users.getFollowsPaginated({followedUser:h.value.connectedAs}),i=P,[4,a.getAll().then((function(e){return e.map((function(e){return{username:e.userDisplayName}}))}))];case 2:return i.value=o.sent(),r(null,"complete"),[2]}}))}))}));var D=function(){return a(p,void 0,void 0,(function(){var r,u,d,p,v,m,g,T,R,C=this;return o(this,(function(P){switch(P.label){case 0:return r=h.value,u=r.clientId,d=r.clientSecret,p=new i.RefreshingAuthProvider({clientId:u,clientSecret:d,onRefresh:function(t){return a(C,void 0,void 0,(function(){return o(this,(function(n){return e.log.info("Refreshing Twitch Credentials"),h.value.accessToken=t.accessToken,h.value.refreshToken=t.refreshToken,h.value.expiresIn=t.expiresIn,h.value.obtainmentTimestamp=t.obtainmentTimestamp,[2]}))}))}},h.value),[4,(t=new c.ApiClient({authProvider:p})).users.getMe().then((function(e){h.value.connectedAs={id:e.id,name:e.name},h.value.isConnected=!0}))];case 1:return P.sent(),n=new s.SingleUserPubSubClient({authProvider:p}),v=b,[4,n.onBits(S("bits"))];case 2:return v.onBits=P.sent(),m=b,[4,n.onRedemption(S("redemption"))];case 3:return m.onRedemption=P.sent(),g=b,[4,n.onBitsBadgeUnlock(S("bitsBadgeUnlock"))];case 4:return g.onBitsBadgeUnlock=P.sent(),f=new l.ChatClient({channels:[h.value.connectedAs.name]}),w.onMessage=f.onMessage(x),w.onAction=f.onAction(x),w.onDelete=f.onMessageRemove(k),w.onTimeout=f.onTimeout(A),[4,f.connect()];case 5:return P.sent(),[4,t.chat.getGlobalBadges()];case 6:return T=P.sent(),[4,t.chat.getChannelBadges(h.value.connectedAs)];case 7:return R=P.sent(),T.forEach((function(e){return y[e.id]=e})),R.forEach((function(e){return y[e.id]=e})),_(),[2]}}))}))},I=u.getTwitchAuthRouter(e,h,D);e.mount("/"+e.bundleName,I),e.listenFor("logoutTwitch",(function(){return a(p,void 0,void 0,(function(){return o(this,(function(e){return b.onBits=void 0,b.onSubscription=void 0,b.onRedemption=void 0,b.onBitsBadgeUnlock=void 0,h.value.isConnected=!1,delete h.value.connectedAs,n=void 0,t=void 0,[2]}))}))})),e.listenFor("clearTwitchEvents",(function(){v.value=[]})),e.listenFor("updateTwitchClips",_),h.value.isConnected&&D().then((function(){return e.log.info("Reconnected to Twitch")}))},e.exports=t.default},function(e,t){e.exports=require("@twurple/auth")},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getTwitchAuthRouter=void 0;var a=r(n(3)),o=r(n(4));function i(e){var t;return(new a.default).protocol((null===(t=e.config.ssl)||void 0===t?void 0:t.enabled)?"https":"http").host(e.config.baseURL).path(e.bundleName+"/callback").toString()}t.getTwitchAuthRouter=function(e,t,n){var r=e.Router();return r.get("/authorize",e.util.authCheck,(function(n,r){var o=new a.default("https://id.twitch.tv/oauth2/authorize").addSearch("client_id",t.value.clientId).addSearch("redirect_uri",i(e)).addSearch("response_type","code").addSearch("force_verify","true").addSearch("scope","channel:read:subscriptions bits:read channel:read:redemptions channel_subscriptions chat:read chat:edit");r.redirect(o.toString())})),r.get("/callback",(function(r,u){var c=new a.default("https://id.twitch.tv/oauth2/token").addSearch("client_id",t.value.clientId).addSearch("client_secret",t.value.clientSecret).addSearch("code",r.query.code).addSearch("redirect_uri",i(e)).addSearch("grant_type","authorization_code");o.default(c.toString(),{method:"POST"}).then((function(e){return e.json()})).then((function(e){t.value.accessToken=e.access_token,t.value.refreshToken=e.refresh_token,u.send("Success, you can now close this window!"),n()}))})),e.listenFor("getAuthorizeUrl",(function(t,n){return n(null,function(e){var t;return(new a.default).protocol((null===(t=e.config.ssl)||void 0===t?void 0:t.enabled)?"https":"http").host(e.config.baseURL).path(e.bundleName+"/authorize").toString()}(e))})),e.listenFor("getCallbackUrl",(function(t,n){return n(null,i(e))})),r}},function(e,t){e.exports=require("urijs")},function(e,t){e.exports=require("node-fetch")},function(e,t){e.exports=require("@twurple/api")},function(e,t){e.exports=require("@twurple/pubsub")},function(e,t){e.exports=require("@twurple/chat")},function(e,t){e.exports=require("@twurple/common")}]);
//# sourceMappingURL=index.js.map